# ──────────────────────────────────────────────────────────────
# Deluthium Connector - Docker Compose
#
# Run individual adapters or the full suite.
#
# Usage:
#   docker compose -f docker/docker-compose.yml up uniswapx-filler
#   docker compose -f docker/docker-compose.yml up institutional
#   docker compose -f docker/docker-compose.yml up --build
# ──────────────────────────────────────────────────────────────

x-common-env: &common-env
  DELUTHIUM_API_KEY: ${DELUTHIUM_API_KEY}
  # SECURITY: Private key is loaded from Docker secrets or a mounted file (CRIT-07).
  # Set PRIVATE_KEY_FILE to a path inside the container (e.g. /run/secrets/private_key).
  # The adapter should read process.env.PRIVATE_KEY_FILE and load the key from that file.
  # Fallback to env var for development only -- NEVER use in production.
  PRIVATE_KEY_FILE: ${PRIVATE_KEY_FILE:-/run/secrets/private_key}
  NODE_ENV: production

secrets:
  private_key:
    file: ${PRIVATE_KEY_SECRET_FILE:-./.secrets/private_key}

services:
  # ── UniswapX Filler ──────────────────────────────────────
  uniswapx-filler:
    build:
      context: ..
      dockerfile: docker/Dockerfile.adapter
      args:
        ADAPTER: uniswapx-adapter
    environment:
      <<: *common-env
      RPC_URL: ${ETH_RPC_URL:-https://eth.llamarpc.com}
      MIN_PROFIT_BPS: ${MIN_PROFIT_BPS:-25}
    secrets:
      - private_key
    restart: unless-stopped

  # ── Hashflow MM ──────────────────────────────────────────
  hashflow-mm:
    build:
      context: ..
      dockerfile: docker/Dockerfile.adapter
      args:
        ADAPTER: hashflow-adapter
    environment:
      <<: *common-env
      HASHFLOW_MM_NAME: ${HASHFLOW_MM_NAME:-deluthium-mm}
    restart: unless-stopped

  # ── Paraswap Pool ────────────────────────────────────────
  paraswap-pool:
    build:
      context: ..
      dockerfile: docker/Dockerfile.adapter
      args:
        ADAPTER: paraswap-adapter
    environment:
      <<: *common-env
      POOL_ADAPTER_ADDRESS: ${POOL_ADAPTER_ADDRESS}
    restart: unless-stopped

  # ── dYdX Bridge ──────────────────────────────────────────
  dydx-bridge:
    build:
      context: ..
      dockerfile: docker/Dockerfile.adapter
      args:
        ADAPTER: dydx-adapter
    environment:
      <<: *common-env
      DYDX_NETWORK: ${DYDX_NETWORK:-mainnet}
      DYDX_ADDRESS: ${DYDX_ADDRESS}
    restart: unless-stopped

  # ── PancakeSwap Router ───────────────────────────────────
  pancakeswap-router:
    build:
      context: ..
      dockerfile: docker/Dockerfile.adapter
      args:
        ADAPTER: binance-dex-adapter
    environment:
      <<: *common-env
      BSC_RPC_URL: ${BSC_RPC_URL:-https://bsc-dataseed1.binance.org}
    restart: unless-stopped

  # ── Institutional (FIX + OTC API) ───────────────────────
  institutional:
    build:
      context: ..
      dockerfile: docker/Dockerfile.adapter
      args:
        ADAPTER: institutional-adapter
    environment:
      <<: *common-env
      FIX_PORT: 9878
      OTC_PORT: 3000
    ports:
      - "${FIX_PORT:-9878}:9878"
      - "${OTC_PORT:-3000}:3000"
    restart: unless-stopped

  # ── Hummingbot Connector ─────────────────────────────────
  hummingbot:
    build:
      context: ..
      dockerfile: docker/Dockerfile.hummingbot
    environment:
      DELUTHIUM_API_KEY: ${DELUTHIUM_API_KEY}
    restart: unless-stopped
